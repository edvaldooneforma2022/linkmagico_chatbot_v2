<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ LinkM√°gico Chatbot v2.0 - IA Conversacional para Vendas</title>
    <style>
        /* --- Estilos CSS (Mantidos do seu design original para consist√™ncia) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header p { font-size: 16px; opacity: 0.9; }
        .form-container { padding: 30px; }
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input[type="text"], .form-group input[type="url"], .form-group textarea { width: 100%; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; font-family: inherit; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .form-group input.error { border-color: #dc3545; }
        .error-message { color: #dc3545; font-size: 12px; margin-top: 5px; display: none; }
        .new-feature { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .new-feature h3 { margin-bottom: 5px; font-size: 18px; }
        .new-feature p { font-size: 14px; opacity: 0.9; }
        .generate-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; transition: transform 0.2s; margin-bottom: 20px; }
        .generate-btn:hover { transform: translateY(-2px); }
        .generate-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .result-container { display: none; background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .result-container.show { display: block; }
        .result-title { font-weight: 600; color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .result-link { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; word-break: break-all; font-family: monospace; font-size: 14px; margin-bottom: 15px; }
        .copy-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .copy-btn:hover { background: #218838; }
        .footer-shortcuts { display: flex; gap: 8px; margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 12px; flex-wrap: wrap; justify-content: center; }
        .shortcut-btn { flex: 1; min-width: 100px; padding: 10px 12px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; text-decoration: none; text-align: center; font-weight: 500; font-size: 12px; transition: all 0.3s; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .shortcut-btn:hover { background: #667eea; color: white; transform: translateY(-1px); }
        .shortcut-btn.active { background: #667eea; color: white; }
        .chat-container { display: none; background: white; border-radius: 12px; margin-top: 20px; height: 400px; border: 2px solid #e9ecef; flex-direction: column; }
        .chat-container.show { display: flex; }
        .chat-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px 10px 0 0; text-align: center; font-weight: 600; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fa; }
        .chat-input-container { padding: 15px; border-top: 1px solid #e9ecef; display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .chat-send-btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 20px; cursor: pointer; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .message.user { background: #667eea; color: white; margin-left: auto; text-align: right; }
        .message.bot { background: white; border: 1px solid #ddd; margin-right: auto; }
        @media (max-width: 768px) { .container { margin: 10px; border-radius: 15px; } .header { padding: 20px; } .header h1 { font-size: 24px; } .form-container { padding: 20px; } .footer-shortcuts { flex-direction: column; } .shortcut-btn { min-width: auto; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ LinkM√°gico Chatbot v2.1</h1>
            <p>IA Conversacional Inteligente para Vendas Online</p>
        </div>
        
        <div class="form-container">
            <div class="new-feature">
                <h3>üöÄ VERS√ÉO PROFISSIONAL: Extra√ß√£o Robusta!</h3>
                <p>A extra√ß√£o de dados agora usa Cheerio para m√°xima compatibilidade e precis√£o.</p>
            </div>
            
            <form id="chatbotForm">
                <div class="form-group">
                    <label for="robotName">ü§ñ Nome do Assistente Virtual:</label>
                    <input type="text" id="robotName" placeholder="@VendedorPro" required>
                    <div class="error-message" id="robotNameError">O nome deve come√ßar com @</div>
                </div>

                <div class="form-group">
                    <label for="salesPageUrl">üîó URL da P√°gina de Vendas:</label>
                    <input type="url" id="salesPageUrl" placeholder="https://exemplo.com/meu-produto" required>
                    <div class="error-message" id="salesPageUrlError">Por favor, insira uma URL v√°lida</div>
                </div>

                <div class="form-group">
                    <label for="customInstructions">üìù Instru√ß√µes Personalizadas (opcional ):</label>
                    <textarea id="customInstructions" placeholder="Ex: Responda de forma animada e motivadora."></textarea>
                </div>
                
                <button type="submit" class="generate-btn" id="generateBtn">
                    üöÄ Ativar Chatbot Inteligente
                </button>
            </form>
            
            <div class="result-container" id="resultContainer">
                <div class="result-title">üéâ Seu Chatbot foi ativado!</div>
                <div class="result-link" id="resultLink"></div>
                <button class="copy-btn" id="copyBtn">üìã Copiar Link do Chat</button>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="chat-header">üí¨ Teste seu Chatbot Aqui</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Digite sua mensagem...">
                    <button class="chat-send-btn" id="chatSendBtn">Enviar</button>
                </div>
            </div>
            
            <div class="footer-shortcuts">
                <button class="shortcut-btn active" data-tab="chatbot">ü§ñ Chatbot</button>
                <button class="shortcut-btn" data-tab="extractor">üìä Extrator</button>
                <button class="shortcut-btn" data-tab="prompt">üí≠ Prompt</button>
                <button class="shortcut-btn" data-tab="social">üì± Redes Sociais</button>
                <button class="shortcut-btn" data-tab="tiktok">üéµ TikTok</button>
                <button class="shortcut-btn" data-tab="kwai">üé• Kwai</button>
                <button class="shortcut-btn" data-tab="linkedin">üíº LinkedIn</button>
                <button class="shortcut-btn" data-tab="telegram">üì± Telegram</button>
                <button class="shortcut-btn" data-tab="analytics">üìà Analytics</button>
            </div>
        </div>
    </div>

    <script>
        // --- L√ìGICA DO FRONTEND (Tudo em um s√≥ lugar para organiza√ß√£o) ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Seletores de Elementos DOM ---
            const form = document.getElementById('chatbotForm');
            const robotNameInput = document.getElementById('robotName');
            const salesPageUrlInput = document.getElementById('salesPageUrl');
            const generateBtn = document.getElementById('generateBtn');
            const chatContainer = document.getElementById('chatContainer');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            
            let extractedDataCache = null; // Cache para os dados extra√≠dos

            // --- Fun√ß√£o Principal de Extra√ß√£o ---
            async function fetchAndExtractData() {
                const url = salesPageUrlInput.value.trim();
                if (!validateUrl(url)) {
                    alert('Por favor, insira uma URL v√°lida da p√°gina de vendas.');
                    return null;
                }

                generateBtn.disabled = true;
                generateBtn.textContent = '‚è≥ Extraindo dados...';

                try {
                    const response = await fetch('/api/extract', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });

                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.error || 'Erro desconhecido no servidor.');
                    }

                    const data = await response.json();
                    extractedDataCache = data; // Salva os dados no cache
                    alert('Dados extra√≠dos com sucesso! O painel est√° pronto.');
                    return data;

                } catch (error) {
                    alert(`Falha na extra√ß√£o: ${error.message}`);
                    return null;
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'üöÄ Ativar Chatbot Inteligente';
                }
            }

            // --- Evento do Formul√°rio Principal ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = await fetchAndExtractData();
                if (data) {
                    chatContainer.classList.add('show');
                    chatMessages.innerHTML = `<div class="message bot">Ol√°! Sou o ${robotNameInput.value || '@Assistente'}. Extra√≠ os dados do produto e estou pronto para ajudar. Pode perguntar!</div>`;
                    chatContainer.scrollIntoView({ behavior: 'smooth' });
                }
            });

            // --- L√≥gica do Chat ---
            async function handleSendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                if (!extractedDataCache) {
                    alert('Por favor, extraia os dados de uma p√°gina de vendas primeiro clicando no bot√£o "Ativar Chatbot".');
                    return;
                }

                addMessageToChat(message, true);
                chatInput.value = '';
                chatSendBtn.disabled = true;

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message, productUrl: salesPageUrlInput.value.trim() })
                    });
                    const result = await response.json();
                    addMessageToChat(result.response, false);
                } catch (error) {
                    addMessageToChat('Desculpe, ocorreu um erro de comunica√ß√£o com o servidor.', false);
                } finally {
                    chatSendBtn.disabled = false;
                    chatInput.focus();
                }
            }

            chatSendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleSendMessage());

            function addMessageToChat(content, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
                messageDiv.textContent = content;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // --- L√≥gica dos Bot√µes do Rodap√© ---
            document.querySelectorAll('.shortcut-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const tab = this.dataset.tab;
                    
                    // Ativa o bot√£o visualmente
                    document.querySelectorAll('.shortcut-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // A maioria das fun√ß√µes precisa dos dados extra√≠dos
                    if (tab !== 'chatbot' && !extractedDataCache) {
                        alert('Extraindo dados da p√°gina primeiro...');
                        const data = await fetchAndExtractData();
                        if (!data) { // Se a extra√ß√£o falhar, para a execu√ß√£o
                            document.querySelector('[data-tab="chatbot"]').classList.add('active');
                            this.classList.remove('active');
                            return;
                        }
                    }
                    
                    // Executa a a√ß√£o correspondente
                    switch(tab) {
                        case 'chatbot':
                            chatContainer.classList.add('show');
                            chatContainer.scrollIntoView({ behavior: 'smooth' });
                            break;
                        case 'extractor':
                            showExtractorInterface();
                            break;
                        case 'prompt':
                            showPromptInterface();
                            break;
                        case 'tiktok':
                        case 'kwai':
                        case 'linkedin':
                        case 'telegram':
                        case 'social':
                            handleSocialShare(tab);
                            break;
                        case 'analytics':
                            alert('Funcionalidade de Analytics em desenvolvimento.');
                            break;
                    }
                });
            });

            function showExtractorInterface() {
                const dataText = `
                    T√≠tulo: ${extractedDataCache.title}\n
                    Pre√ßo: ${extractedDataCache.price}\n
                    Descri√ß√£o: ${extractedDataCache.description.substring(0, 100)}...\n
                    Benef√≠cios: ${extractedDataCache.benefits.join(', ')}
                `;
                alert("Dados Extra√≠dos:\n" + dataText);
            }

            function showPromptInterface() {
                const prompt = `Crie uma copy de vendas para o produto "${extractedDataCache.title}", que custa "${extractedDataCache.price}". Destaque os benef√≠cios: ${extractedDataCache.benefits.join(', ')}.`;
                copyToClipboard(prompt, "Prompt de Vendas");
            }

            function handleSocialShare(platform) {
                const url = salesPageUrlInput.value.trim();
                const title = extractedDataCache.title;
                let message = `Confira este produto incr√≠vel: ${title}! Saiba mais em: ${url}`;
                
                if (platform === 'linkedin') {
                    window.open(`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url )}&title=${encodeURIComponent(title)}`, '_blank');
                } else if (platform === 'telegram') {
                    window.open(`https://t.me/share/url?url=${encodeURIComponent(url )}&text=${encodeURIComponent(message)}`, '_blank');
                } else {
                    // Para TikTok, Kwai e o bot√£o geral "Redes Sociais"
                    copyToClipboard(message, platform.charAt(0).toUpperCase() + platform.slice(1));
                }
            }

            // --- Fun√ß√µes Utilit√°rias ---
            function validateUrl(url) {
                try {
                    new URL(url);
                    return url.startsWith('http' );
                } catch {
                    return false;
                }
            }

            function copyToClipboard(text, platformName) {
                navigator.clipboard.writeText(text).then(() => {
                    alert(`Texto para ${platformName} copiado para a √°rea de transfer√™ncia!\n\n"${text}"`);
                }).catch(err => {
                    alert('Erro ao copiar. Verifique as permiss√µes do seu navegador.');
                });
            }
        });
    </script>
</body>
</html>
